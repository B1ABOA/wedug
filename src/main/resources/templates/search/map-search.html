<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="include/head-meta-fragment :: head-mata"></th:block>
<body>
<script th:inline="javascript">
    var apiKey = [[${apiKey}]];
</script>
    <th:block th:replace="include/header-fragment :: header"></th:block>
    <main class="main-flex">
        <div class="search-container">
            <form action="#" method="get">
                <div>
                    <select class="search-option" name="category">
                        <option value="100">artist</option>
                        <option value="200">drama</option>
                        <option value="300">movie</option>
                        <option value="400">show</option>
                    </select>
                    <select class="search-option" name="place">
                        <option value="10">cafe</option>
                        <option value="20">playground</option>
                        <option value="30">restaurant</option>
                        <option value="40">stay</option>
                        <option value="50">store</option>
                    </select>
                </div>
                <div class="search-box">
                    <input class="search-txt" type="text" name="" placeholder="검색어를 입력하세요.">
                    <button class="search-button" type="submit">
                        <img src="/images/icons/search.svg">
                    </button>
                </div>
            </form>
        </div>
        <div class="map-container">
            <!-- 지도 삽입 공간 -->
            <div id="map">지도 영역</div>
            <button onclick="findMyLocation()">내 위치 찾기</button>
        </div>
    </main>
    <th:block th:replace="include/navbar-fragment :: navbar"></th:block>
    <th:block th:replace="include/footer-fragment :: footer"></th:block>
<script>
    var map; // 전역 변수로 map 선언

    function loadKakaoMaps(callback) {
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'http://dapi.kakao.com/v2/maps/sdk.js?appkey=' + apiKey + '&autoload=false';
        script.onload = callback;
        document.head.appendChild(script);
    }

    function initMap() {
        kakao.maps.load(function() {
            var mapContainer = document.getElementById('map');
            var mapOption = {
                center: new kakao.maps.LatLng(33.450701, 126.570667),
                level: 3
            };

            map = new kakao.maps.Map(mapContainer, mapOption);

            // 초기 위치 설정
            setMyLocation();
        });
    }

    // 내 위치 설정 함수
    function setMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                var locPosition = new kakao.maps.LatLng(lat, lon);

                map.setCenter(locPosition);

                // 기존 마커 제거
                removeMarker();

                // 새 마커 생성
                var marker = new kakao.maps.Marker({
                    position: locPosition
                });
                marker.setMap(map);

                // 마커를 전역 변수에 저장
                window.currentMarker = marker;

            }, function(error) {
                console.log('Geolocation failed: ' + error.message);
            }, {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            });
        } else {
            console.log('Geolocation is not supported by this browser.');
        }
    }

    // 마커 제거 함수
    function removeMarker() {
        if (window.currentMarker) {
            window.currentMarker.setMap(null);
        }
    }

    // 내 위치 찾기 버튼 클릭 시 실행될 함수
    function findMyLocation() {
        setMyLocation();
    }

    loadKakaoMaps(initMap);
</script>
</body>
</html>
